version: "2"

services:
  conda-store-build:
    build: .
    volumes:
      - ./tests/assets/environments:/opt/environments:ro
      - ./mount:/opt/mount
    command: ['python', '-m', 'conda_store', 'build', '-p', '/opt/environments', '-o', '/opt/mount/environments', '-s', '/opt/mount/store', '--uid', '1000', '--gid', '100', '--permissions', '775', '--storage-backend', 's3']
    environment:
      TZ: America/New_York
      S3_ENDPOINT: 10.10.0.6:9000
      S3_ACCESS_KEY: minio_access_key
      S3_SECRET_KEY: minio_secret_key
      PATH: "/opt/conda/envs/conda-store/bin:/opt/conda/bin:/opt/conda/condabin:/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    networks:
      testing_network:
        ipv4_address: 10.10.0.2

  conda-store-ui:
    build: .
    volumes:
      - ./mount:/opt/mount
    command: ['python', '-m', 'conda_store', 'ui', '-s', '/opt/mount/store', '--port', '5000']
    ports:
      - "5000:5000"
    environment:
      TZ: America/New_York
      S3_ENDPOINT: 10.10.0.6:9000
      S3_ACCESS_KEY: minio_access_key
      S3_SECRET_KEY: minio_secret_key
      PATH: "/opt/conda/envs/conda-store/bin:/opt/conda/bin:/opt/conda/condabin:/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    networks:
      testing_network:
        ipv4_address: 10.10.0.3

  conda-store-api:
    build: .
    volumes:
      - ./mount:/opt/mount
    command: ['python', '-m', 'conda_store', 'api', '-s', '/opt/mount/store', '--port', '5001']
    ports:
      - "5001:5001"
    environment:
      TZ: America/New_York
      PATH: "/opt/conda/envs/conda-store/bin:/opt/conda/bin:/opt/conda/condabin:/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    networks:
      testing_network:
        ipv4_address: 10.10.0.4

  conda-store-registry:
    build: .
    volumes:
      - ./mount:/opt/mount
    command: ['python', '-m', 'conda_store', 'registry', '-s', '/opt/mount/store', '--port', '5002', '--storage-backend', 's3']
    ports:
      - "5002:5002"
    environment:
      TZ: America/New_York
      S3_ENDPOINT: 10.10.0.6:9000
      S3_ACCESS_KEY: minio_access_key
      S3_SECRET_KEY: minio_secret_key
      PATH: "/opt/conda/envs/conda-store/bin:/opt/conda/bin:/opt/conda/condabin:/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    networks:
      testing_network:
        ipv4_address: 10.10.0.5

  minio:
    image: minio/minio:RELEASE.2020-11-10T21-02-24Z
    ports:
      - "9000:9000"
    command: server /var/lib/minio
    environment:
      MINIO_ACCESS_KEY: minio_access_key
      MINIO_SECRET_KEY: minio_secret_key
    networks:
      testing_network:
        ipv4_address: 10.10.0.6

networks:
  testing_network:
    ipam:
      driver: default
      config:
        - subnet: 10.10.0.0/24
